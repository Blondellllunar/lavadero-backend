<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Aseo por QR</title>

<style>
body {
  font-family: Arial;
  background: #f4f6f8;
}
.card {
  max-width: 400px;
  margin: 40px auto;
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,.2);
}
button {
  width: 100%;
  padding: 10px;
  background: #1e88e5;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}
#mensajeExito {
  display:none;
  margin-top:15px;
  color:green;
  font-weight:bold;
  text-align:center;
}
</style>
</head>

<body>

<div class="card">
  <h3 id="nombre">Cargando...</h3>
  <p id="turno"></p>

  <form id="formAseo">
    <label><input type="radio" name="tarea" value="Limpiar plancha"> Limpiar plancha</label><br>
    <label><input type="radio" name="tarea" value="Barrer zona de secado"> Barrer zona de secado</label><br>
    <label><input type="radio" name="tarea" value="Limpiar baño"> Limpiar baño</label><br>
    <label><input type="radio" name="tarea" value="Cárcamos"> Cárcamos</label><br><br>

    <button type="submit">Guardar</button>

    <p id="mensajeExito">✅ Tu aseo fue reportado con éxito</p>
  </form>
</div>

<script>
// Obtener parámetro del QR
const params = new URLSearchParams(window.location.search);
const lavadorId = params.get("lavador");

// Validar QR
if (!lavadorId) {
  document.body.innerHTML = "<h2 style='text-align:center'>❌ QR inválido</h2>";
  throw new Error("QR sin parámetro lavador");
}

// Cargar lavador
fetch(`/lavadores/${lavadorId}`)
  .then(res => {
    if (!res.ok) throw new Error("Lavador no encontrado");
    return res.json();
  })
  .then(lavador => {
    document.getElementById("nombre").textContent = lavador.nombre;
    document.getElementById("turno").textContent = "Turno: " + lavador.turno;
    window.lavador = lavador;
  })
  .catch(err => {
    console.error(err);
    document.body.innerHTML = "<h2 style='text-align:center'>❌ Error cargando el QR</h2>";
  });

// Guardar aseo
document.getElementById("formAseo").addEventListener("submit", e => {
  e.preventDefault();

  const tarea = document.querySelector("input[name=tarea]:checked");
  if (!tarea) {
    alert("Seleccione una tarea");
    return;
  }

  fetch("/aseo", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      turno: window.lavador.turno,
      lavador_id: window.lavador.id,
      tareas: [tarea.value]
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.message) {
      document.getElementById("mensajeExito").style.display = "block";
    } else {
      alert("No se pudo registrar");
    }
  })
  .catch(() => {
    alert("Error guardando aseo");
  });
});
</script>

</body>
</html>