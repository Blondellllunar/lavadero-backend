<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Aseo por QR</title>

<style>
body {
  font-family: Arial;
  background: #f4f6f8;
}
.card {
  max-width: 400px;
  margin: 40px auto;
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,.2);
}
button {
  width: 100%;
  padding: 10px;
  background: #1e88e5;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}
#mensajeExito {
  display:none;
  margin-top:15px;
  color:green;
  font-weight:bold;
  text-align:center;
}
</style>
</head>

<body>

<div class="card">
  <h3 id="nombre"></h3>
  <p id="turno"></p>

  <form id="formAseo">
    <label><input type="radio" name="tarea" value="Limpiar plancha"> Limpiar plancha</label><br>
    <label><input type="radio" name="tarea" value="Barrer zona de secado"> Barrer zona de secado</label><br>
    <label><input type="radio" name="tarea" value="Limpiar baÃ±o"> Limpiar baÃ±o</label><br>
    <label><input type="radio" name="tarea" value="CÃ¡rcamos"> CÃ¡rcamos</label><br><br>

    <button type="submit">Guardar</button>

    <p id="mensajeExito">âœ… Tu aseo fue reportado con Ã©xito</p>
  </form>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const token = params.get("token");

if (!token) {
  document.body.innerHTML = "âŒ QR invÃ¡lido";
  throw new Error("QR invÃ¡lido");
}

// ðŸ”¹ Obtener info del lavador desde el QR
fetch(`/aseo/qr/${token}`)
  .then(res => {
    if (!res.ok) throw new Error("QR no vÃ¡lido");
    return res.json();
  })
  .then(lavador => {
    document.getElementById("nombre").textContent = lavador.nombre;
    document.getElementById("turno").textContent = "Turno: " + lavador.turno;
    window.lavador = lavador;
  })
  .catch(err => {
    document.body.innerHTML = "âŒ Error cargando el QR";
    console.error(err);
  });

// ðŸ”¹ Enviar aseo
document.getElementById("formAseo").addEventListener("submit", e => {
  e.preventDefault();

  const tarea = document.querySelector("input[name=tarea]:checked");
  if (!tarea) return alert("Seleccione una tarea");

  fetch("/aseo", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      turno: window.lavador.turno,
      lavador_id: window.lavador.id,
      tareas: [tarea.value],
      observacion: null
    })
  })
  .then(r => r.json())
  .then(d => {
    if (d.message && d.message.toLowerCase().includes("registrado")) {
      document.getElementById("mensajeExito").style.display = "block";
      document.querySelectorAll("input[name=tarea]").forEach(r => r.checked = false);
    } else {
      alert(d.message || "Error registrando aseo");
    }
  })
  .catch(err => {
    alert("Error enviando aseo");
    console.error(err);
  });
});
</script>

</body>
</html>